<!-- Curved Falling Lines – FIXED
- Direction: TOP → BOTTOM (dashoffset decreases)
- No mid-air pause/jump (pure rAF; no CSS delay between loops)
- Even spacing with +2 side lines; fan-out +30%; converge at (center, bottom-70px)
-->
<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Curved Falling Lines</title>
<style>
  html,body{height:100%;margin:0;background:#0E1011;overflow:hidden}
  svg{position:fixed;inset:0;width:100%;height:100%;display:block}
  .track{fill:none;stroke:rgba(255,255,255,.08);stroke-width:1}
  .runner{fill:none;stroke-width:1;stroke-linecap:round}
</style>
</head><body>
<svg id="stage" preserveAspectRatio="none"></svg>
<script>
const COLORS=["#FFC413","#00A652","#FFBCFC","#4A4A48","#00A652","#C4C8FF"];
const LINE_CNT=14;                  // 12 + 2 line hai bên
const OPEN=1.3;                     // mở rộng 30%
const FOCUS_OFF=70;                 // điểm chụm cách đáy 70px
const SEG_MIN=50, SEG_MAX=150;      // chiều dài vệt
const DURATION=7;                   // giây cho một lượt rơi

const svg=document.getElementById('stage');
const pick=a=>a[(Math.random()*a.length)|0];
const lerp=(a,b,t)=>a+(b-a)*t;

let runners=[]; // {el,len,seg,start,end,t}

/* path cong chụm vào tâm đáy */
function makePath(x0,w,h){
  const cx=w*0.5, cy=h-FOCUS_OFF;
  const c1x=x0, c1y=h*0.35;
  const c2x=x0+(cx-x0)*0.9;               // uốn nhiều hơn
  const c2y=h*(0.78-0.15*(OPEN-1));
  return `M ${x0},0 C ${c1x},${c1y} ${c2x},${c2y} ${cx},${cy}`;
}

function build(){
  svg.innerHTML=''; runners.length=0;
  const w=svg.clientWidth, h=svg.clientHeight;
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);

  // chia đều theo fan-out mở rộng
  const L=w*0.5-(w*0.5*OPEN), R=w*0.5+(w*0.5*OPEN);
  const xs=Array.from({length:LINE_CNT},(_,i)=>lerp(L,R,i/(LINE_CNT-1)));

  xs.forEach(x=>{
    const d=makePath(x,w,h);

    const t=document.createElementNS('http://www.w3.org/2000/svg','path');
    t.setAttribute('class','track'); t.setAttribute('d',d); svg.appendChild(t);

    const r=document.createElementNS('http://www.w3.org/2000/svg','path');
    r.setAttribute('class','runner'); r.setAttribute('d',d); r.setAttribute('stroke',pick(COLORS));
    svg.appendChild(r);

    const len=r.getTotalLength();
    const seg=Math.round(lerp(SEG_MIN,SEG_MAX,Math.random()));
    r.style.strokeDasharray=`${seg} ${len}`;

    // TOP → BOTTOM: dashoffset đi từ (len+seg) xuống (-seg) LIÊN TỤC
    runners.push({
      el:r, len, seg,
      start: len+seg,
      end:  -seg,
      t: Math.random()*DURATION // lệch pha ban đầu, không delay khi loop
    });
  });
}

let last=performance.now();
function loop(now){
  const dt=Math.min(50, now-last)/1000; last=now;
  for(const r of runners){
    r.t=(r.t+dt)%DURATION;
    const off=lerp(r.start, r.end, r.t/DURATION); // decreasing → TOP→BOTTOM
    r.el.style.strokeDashoffset=`${off}px`;
  }
  requestAnimationFrame(loop);
}

build(); requestAnimationFrame(loop);

/* Chỉ rebuild khi kích thước thay đổi đáng kể (tránh “nhảy vị trí” do layout động) */
let w0=innerWidth, h0=innerHeight, timer=0;
addEventListener('resize',()=>{
  clearTimeout(timer);
  timer=setTimeout(()=>{
    if(Math.abs(innerWidth-w0)>8 || Math.abs(innerHeight-h0)>8){
      w0=innerWidth; h0=innerHeight; build();
    }
  },300);
},{passive:true});
</script>
</body></html>
